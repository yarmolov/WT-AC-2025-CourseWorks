# Вариант 11 — Матрица прав (операция × роль)

Операции: Просмотр проектов, Создать/Редактировать/Удалить Project, Управление участниками проекта, Просмотр багов, Создать Bug, Редактировать Bug, Удалить Bug, Назначить Bug, Изменить статус, Добавить комментарий, Добавить вложение, Управление пользователями.

Роли: Администратор, Менеджер, Разработчик, Пользователь (Reporter)

## Таблица (кто может что)

### Проекты

- **Просмотр проектов**:
  - Администратор: все проекты
  - Менеджер: публичные + проекты, где он участник (ProjectMember)
  - Разработчик: публичные + проекты, где он участник (ProjectMember)
  - Пользователь: публичные проекты

- **Создать Project**:
  - Администратор: да

- **Редактировать Project**:
  - Администратор: все проекты
  - Owner проекта (Project.owner_id = user): свой проект
  - Manager (ProjectMember.role = 'manager'): нет (только owner может редактировать настройки проекта)

- **Удалить Project**:
  - Администратор: да

- **Управление участниками проекта** (добавить/удалить ProjectMember):
  - Администратор: да
  - Owner проекта: да
  - Manager проекта (ProjectMember.role = 'manager'): может добавлять, но не удалять

### Баги

- **Просмотр багов**:
  - Администратор: все баги
  - Менеджер: баги в проектах, где он участник (ProjectMember) + публичные
  - Разработчик: баги в проектах, где он участник (ProjectMember) + публичные
  - Пользователь: баги в публичных проектах

- **Создать Bug**:
  - Администратор: в любом проекте
  - Менеджер: в проектах, где он участник (ProjectMember)
  - Разработчик: в проектах, где он участник (ProjectMember)
  - Пользователь: в публичных проектах

- **Редактировать Bug**:
  - Администратор: все поля, все баги
  - Owner/Manager проекта (ProjectMember.role IN ('owner', 'manager')): все поля в своих проектах
  - Developer (ProjectMember.role = 'developer'): только баги, где assigned_to = себе или created_by = себе; только поля: status, description
  - Автор бага (Bug.created_by = user): только description

- **Удалить Bug**:
  - Администратор: да
  - Owner/Manager проекта: в своих проектах

- **Назначить Bug** (изменить assigned_to):
  - Администратор: да
  - Owner/Manager проекта: в своих проектах
  - Developer: нет (не может переназначать)

- **Изменить статус**:
  - Администратор: да
  - Owner/Manager проекта: в своих проектах
  - Developer: только для багов, где assigned_to = себе
  - Автор: нет (только через комментарии просит изменить)

### Комментарии и вложения

- **Добавить комментарий**:
  - Администратор: к любому багу
  - Менеджер: к багам в своих проектах
  - Разработчик: к багам в своих проектах
  - Пользователь: к багам в публичных проектах

- **Редактировать/Удалить комментарий**:
  - Администратор: любой комментарий
  - Автор комментария: свой комментарий
  - Owner/Manager проекта: комментарии в своих проектах

- **Добавить вложение**:
  - Администратор: к любому багу
  - Менеджер: к багам в своих проектах
  - Разработчик: к багам в своих проектах
  - Пользователь: к багам в публичных проектах

- **Удалить вложение**:
  - Администратор: любое вложение
  - Автор вложения (Attachment.uploaded_by = user): своё вложение
  - Owner/Manager проекта: вложения в своих проектах

### Пользователи

- **Управление пользователями** (CRUD /users):
  - Администратор: полный доступ
  - Остальные: только просмотр и редактирование своего профиля (username, email, password)

## Примечания

- **ProjectMember.role определяет уровень доступа к проекту:**
  - `owner`: полный контроль (редактирование проекта, управление участниками, все операции с багами)
  - `manager`: управление багами (CRUD, назначение, изменение статусов/приоритетов)
  - `developer`: работа с назначенными багами (редактирование своих, смена статуса)
  - `viewer`: только просмотр проекта и багов

- **Проверка прав происходит на уровне API middleware:**
  - `requireAuth()`: проверяет JWT токен
  - `requireRole(...roles)`: проверяет глобальную роль (User.role)
  - `requireProjectAccess(projectId, minRole)`: проверяет участие в проекте через ProjectMember

- **Публичность (Project.is_public):**
  - Если `true`: проект и все его баги видны всем пользователям
  - Если `false`: доступ только участникам (ProjectMember) и администраторам

- **Безопасность при удалении:**
  - Нельзя удалить User, если у него есть баги (Bug.created_by)
  - При удалении User: Bug.assigned_to → SET NULL
  - При удалении Project: каскадно удаляются Bug, Attachment, Comment, ProjectMember
