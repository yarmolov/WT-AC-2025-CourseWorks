# Вариант 11 — Баг-трекер «Не баг, а фича?» — Роли и действия

Краткое описание

MVP: Bug, Project, User, ProjectMember, Attachment, Comment. UI отображает доску с багами и фильтры по статусам/приоритетам; API: /projects, /bugs, /attachments, /users, /comments. Приёмка (MVP): корректная работа фильтров, доски и системы прав доступа через ProjectMember.

## Роли и основные действия

### Глобальные роли (User.role)

#### Администратор (admin)

- CRUD для пользователей (/users)
- CRUD для всех проектов (Project)
- Управление правами и ролями
- Просмотр всех багов и статистики
- Полный доступ ко всем ресурсам системы
- Может добавлять/удалять участников в любой проект

#### Менеджер (manager)

- Просмотр проектов, где он участник (ProjectMember) или публичных
- Создание багов в своих проектах
- Полное управление багами в проектах, где ProjectMember.role IN ('owner', 'manager')
- Назначение багов на разработчиков
- Изменение приоритетов и статусов багов
- Просмотр отчётов по проекту
- Добавление участников в свои проекты (если owner или manager роль в ProjectMember)

#### Разработчик (developer)

- Просмотр проектов, где он участник (ProjectMember) или публичных
- Просмотр багов в своих проектах
- Создание багов в своих проектах
- Редактирование багов, назначенных на него (assigned_to = себе)
- Изменение статуса своих назначенных багов
- Добавление комментариев и вложений в своих проектах
- НЕ может назначать баги или управлять участниками проекта

#### Пользователь / Reporter (user)

- Просмотр публичных проектов
- Создание багов в публичных проектах
- Добавление комментариев к багам в публичных проектах
- Редактирование description своих багов (created_by = себе)
- Просмотр статуса своих багов
- НЕ может изменять статусы или назначать баги

### Роли участников проекта (ProjectMember.role)

Эти роли определяют уровень доступа к конкретному проекту:

#### Owner (владелец проекта)

- Автоматически назначается при создании проекта (Project.owner_id)
- Может редактировать настройки проекта
- Полное управление участниками (добавление/удаление)
- Полное управление багами проекта
- НЕ может удалить сам себя из участников

#### Manager (менеджер проекта)

- Полное управление багами (CRUD, назначение, изменение статусов/приоритетов)
- Может добавлять новых участников (developer, viewer)
- НЕ может редактировать настройки проекта
- НЕ может удалять участников (только owner)

#### Developer (разработчик проекта)

- Создание багов
- Редактирование и изменение статуса назначенных на него багов
- Добавление комментариев и вложений
- НЕ может назначать баги или управлять участниками

#### Viewer (наблюдатель)

- Только просмотр проекта и багов
- Может добавлять комментарии
- НЕ может создавать или редактировать баги

## Примеры сценариев

### Сценарий 1: Создание проекта и работа с багами

1. **Администратор** создаёт Project через POST /projects
   - Автоматически создаётся ProjectMember с role='owner' для указанного владельца
2. **Owner проекта** добавляет участников через POST /projects/{id}/members
   - Добавляет Менеджера (role='manager')
   - Добавляет Разработчиков (role='developer')
3. **Пользователь** (reporter) создаёт Bug в проекте через POST /bugs
   - Баг создаётся со статусом 'new'
4. **Менеджер** просматривает баги и назначает Bug на Разработчика
   - PATCH /bugs/{id}/assign с payload {assignedTo: developerId}
5. **Разработчик** получает назначенный баг:
   - Изменяет статус на "in_progress" через PATCH /bugs/{id}/status
   - Добавляет комментарий о прогрессе
   - Прикрепляет screenshot через POST /attachments
6. **Разработчик** завершает работу:
   - Изменяет статус на "done"
7. **Менеджер** проверяет исправление:
   - Изменяет статус на "testing"
   - После тестирования: "closed"

### Сценарий 2: Публичный проект

1. **Администратор** создаёт публичный проект (is_public=true)
2. **Любой пользователь** (даже не участник) может:
   - Просматривать проект через GET /projects/{id}
   - Видеть все баги проекта через GET /bugs?projectId=
   - Создавать новые баги через POST /bugs
   - Добавлять комментарии
3. **Только участники проекта** могут:
   - Назначать баги (manager)
   - Изменять статусы (manager, developer для своих)
   - Удалять баги (owner, manager)

### Сценарий 3: Просмотр доски (Kanban)

1. **Пользователь** открывает страницу проекта
2. Система проверяет права доступа:
   - Публичный проект: доступ есть
   - Приватный проект: проверяет ProjectMember
3. Frontend запрашивает GET /projects/{id}/board
4. Backend возвращает баги, сгруппированные по статусам:

   ```json
   {
     "new": [bug1, bug2],
     "in_progress": [bug3],
     "testing": [bug4],
     "done": [bug5, bug6],
     "closed": []
   }
   ```

5. **Пользователь** применяет фильтры:
   - По приоритету: ?priority=high
   - По разработчику: ?assignedTo={userId}
6. Доска обновляется с отфильтрованными багами

### Сценарий 4: Управление участниками

1. **Owner проекта** заходит в настройки проекта
2. Просматривает список участников GET /projects/{id}/members
3. Добавляет нового разработчика:
   - POST /projects/{id}/members
   - Payload: {userId: "...", role: "developer"}
4. Повышает разработчика до менеджера:
   - PUT /projects/{id}/members/{userId}
   - Payload: {role: "manager"}
5. Удаляет участника из проекта:
   - DELETE /projects/{id}/members/{userId}

## Разграничение прав: User.role vs ProjectMember.role

**User.role (глобальная роль):**

- Определяет общие права в системе
- `admin` - доступ ко всему
- `manager`, `developer`, `user` - ограниченный доступ

**ProjectMember.role (роль в проекте):**

- Определяет права доступа к конкретному проекту
- Один пользователь может иметь разные роли в разных проектах
- Например: User.role='user', но ProjectMember.role='manager' в проекте А

**Приоритет проверки:**

1. Если User.role='admin' → полный доступ (без проверки ProjectMember)
2. Иначе → проверяется наличие ProjectMember и его роль
3. Для публичных проектов → базовый доступ всем (просмотр, создание багов)

## Middleware для проверки прав

```typescript
// Псевдокод для middleware
requireAuth() // проверяет JWT токен, устанавливает req.user

requireRole(...roles: UserRole[]) // проверяет User.role

requireProjectAccess(projectId, minRole?: ProjectMemberRole)
  // 1. Если admin → разрешить
  // 2. Если проект публичный и minRole не указана → разрешить просмотр
  // 3. Проверить ProjectMember:
  //    - существует запись для user + project
  //    - ProjectMember.role >= minRole
  
requireBugAccess(bugId, operation: 'read' | 'update' | 'delete')
  // 1. Получить баг и его проект
  // 2. Если admin → разрешить
  // 3. Проверить доступ к проекту через requireProjectAccess
  // 4. Для 'update': дополнительно проверить assigned_to или created_by
```
