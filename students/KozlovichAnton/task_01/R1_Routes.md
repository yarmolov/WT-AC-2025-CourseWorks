# Вариант 11 — Баг-трекер «Не баг, а фича?» — Маршруты (user flows)

## 1. Идентификация (вход в систему)

- **Пользователь любой роли**: логин через /auth/login → получение JWT токена
- **Администратор**: после логина → доступ к админ-панели (/admin)
- **Менеджер**: после логина → дашборд с проектами, где он участник
- **Разработчик**: после логина → дашборд с назначенными на него багами
- **Пользователь (Reporter)**: после логина → список публичных проектов

## 2. Подготовка данных (Администратор)

- Создать первого администратора через /auth/register (только при bootstrap)
- Создать остальных пользователей через /users (POST)
- Создать проекты (Project) через /projects (POST)
- Указать владельца проекта (owner_id)
- Настроить публичность проекта (is_public)

## 3. Работа с проектами (Администратор, Owner проекта)

- **Создание проекта** (Admin):
  - POST /projects → создаётся Project
  - Автоматически создаётся ProjectMember с role='owner' для owner_id

- **Редактирование проекта** (Admin, Owner):
  - PUT /projects/{id} → изменение name, description, is_public

- **Удаление проекта** (Admin):
  - DELETE /projects/{id} → каскадное удаление всех связанных данных

- **Управление участниками** (Admin, Owner, Manager):
  - GET /projects/{id}/members → просмотр списка участников
  - POST /projects/{id}/members → добавление нового участника
    - Payload: {userId, role: 'manager' | 'developer' | 'viewer'}
  - PUT /projects/{id}/members/{userId} → изменение роли участника (только Owner)
  - DELETE /projects/{id}/members/{userId} → удаление участника (только Owner/Admin)

## 4. Работа с багами (все авторизованные пользователи)

- **Создание бага**:
  - POST /bugs
  - Доступ: участники проекта (ProjectMember) ИЛИ любой пользователь для публичных проектов
  - Payload: {projectId, title, description, priority}
  - created_by автоматически устанавливается из JWT

- **Просмотр списка багов**:
  - GET /bugs?projectId=&status=&priority=&assignedTo=&createdBy=
  - Фильтры работают независимо и могут комбинироваться
  - Доступ: Admin видит все; остальные - свои проекты + публичные

- **Просмотр деталей бага**:
  - GET /bugs/{id}
  - Возвращает баг с комментариями и вложениями
  - Доступ: участники проекта или публичный проект

- **Редактирование бага**:
  - PUT /bugs/{id}
  - Права зависят от роли (см. матрицу прав)
  - Admin/Manager: все поля
  - Developer: только assigned_to=себе, поля: status, description
  - Автор: только description

- **Удаление бага**:
  - DELETE /bugs/{id}
  - Доступ: Admin, Owner/Manager проекта

## 5. Просмотр и фильтрация (все пользователи)

- **Список проектов**:
  - GET /projects
  - Admin: все проекты
  - Остальные: публичные + свои проекты (ProjectMember)

- **Доска (Kanban)**:
  - GET /projects/{id}/board
  - Возвращает баги, сгруппированные по статусам
  - Поддерживает фильтры: ?priority=&assignedTo=
  - Доступ: участники проекта или публичный проект

- **Детали бага**:
  - GET /bugs/{id}
  - Отображает: описание, статус, приоритет, исполнитель, автор
  - Список комментариев (GET /comments?bugId=)
  - Список вложений (GET /attachments?bugId=)

## 6. Управление багами (Менеджер, Разработчик)

- **Назначение бага на разработчика** (Admin, Manager):
  - PATCH /bugs/{id}/assign
  - Payload: {assignedTo: userId | null}
  - Можно назначать только участников проекта с role='developer'

- **Изменение статуса** (Admin, Manager, Developer для своих):
  - PATCH /bugs/{id}/status
  - Payload: {status: 'new' | 'in_progress' | 'testing' | 'done' | 'closed'}
  - Developer может менять только для assigned_to=себе

- **Изменение приоритета** (Admin, Manager):
  - PUT /bugs/{id}
  - Payload: {priority: 'low' | 'medium' | 'high' | 'critical'}

- **Перемещение на доске**:
  - Frontend: drag & drop → вызывает PATCH /bugs/{id}/status
  - Backend проверяет права доступа перед изменением

- **Закрытие бага** (Admin, Manager, Developer для своих):
  - PATCH /bugs/{id}/status с {status: 'closed'}
  - Опционально: добавить комментарий о причине закрытия

## 7. Комментарии и вложения (все пользователи с доступом к проекту)

- **Добавление комментария**:
  - POST /comments
  - Payload: {bugId, content}
  - HTML санитизируется (XSS защита)
  - Доступ: участники проекта или публичный проект

- **Редактирование комментария**:
  - PUT /comments/{id}
  - Доступ: автор комментария или Admin

- **Удаление комментария**:
  - DELETE /comments/{id}
  - Доступ: автор, Admin, Owner/Manager проекта

- **Загрузка вложения**:
  - POST /attachments
  - Multipart/form-data: {bugId, file}
  - Валидация: max 10MB, типы: image/*, pdf, text
  - Доступ: участники проекта или публичный проект

- **Скачивание вложения**:
  - GET /attachments/{id}/download
  - Возвращает файл с корректными headers
  - Доступ: участники проекта или публичный проект

- **Удаление вложения**:
  - DELETE /attachments/{id}
  - Доступ: автор вложения, Admin, Owner/Manager проекта

## 8. Отчёты и статистика (Admin, Manager)

- **Активность по проекту**:
  - GET /projects/{id}/activity
  - Возвращает последние действия (создание/обновление багов)

- **Статистика багов**:
  - GET /projects/{id}/stats
  - Количество багов по статусам и приоритетам
  - Средний срок решения бага

- **Личный дашборд**:
  - GET /bugs?assignedTo=me
  - Список багов, назначенных на текущего пользователя

## 9. Типичные user flows

### Flow 1: Создание и решение бага

1. **Пользователь** → заходит на страницу публичного проекта
2. **Пользователь** → нажимает "Создать баг" → заполняет форму → POST /bugs
3. **Менеджер** → видит новый баг на доске (status='new')
4. **Менеджер** → назначает на разработчика → PATCH /bugs/{id}/assign
5. **Разработчик** → видит баг в своём списке задач
6. **Разработчик** → открывает баг → меняет status на 'in_progress' → PATCH /bugs/{id}/status
7. **Разработчик** → добавляет комментарий "Начал работу" → POST /comments
8. **Разработчик** → исправляет баг → меняет status на 'done'
9. **Менеджер** → проверяет исправление → меняет status на 'testing'
10. **Менеджер** → после тестирования → меняет status на 'closed'

### Flow 2: Управление приватным проектом

1. **Admin** → создаёт проект (is_public=false) → POST /projects
2. **Admin** → добавляет владельца в участники → автоматически при создании
3. **Owner проекта** → добавляет менеджера → POST /projects/{id}/members {role: 'manager'}
4. **Owner проекта** → добавляет разработчиков → POST /projects/{id}/members {role: 'developer'}
5. **Manager** → создаёт баги в проекте → POST /bugs
6. **Manager** → назначает баги на разработчиков → PATCH /bugs/{id}/assign
7. **Developer** → видит только баги своего проекта
8. **Посторонний пользователь** → НЕ видит проект в списке (is_public=false, не участник)

### Flow 3: Работа с доской

1. **Пользователь** → открывает проект → переход на /projects/{id}/board
2. **Frontend** → запрашивает GET /projects/{id}/board
3. **Backend** → проверяет права доступа (ProjectMember или публичный проект)
4. **Backend** → возвращает баги, сгруппированные по статусам
5. **Frontend** → отображает 5 колонок (new, in_progress, testing, done, closed)
6. **Пользователь** → применяет фильтр "priority=high"
7. **Frontend** → запрашивает GET /projects/{id}/board?priority=high
8. **Frontend** → обновляет доску с отфильтрованными багами
9. **Manager** → drag & drop бага из 'new' в 'in_progress' (если права позволяют)
10. **Frontend** → вызывает PATCH /bugs/{id}/status {status: 'in_progress'}
