# Вариант 14 — Матрица прав (операция × роль)

Операции: Просмотр тем, Создать/Редактировать/Удалить Topic, Просмотр целей, Создать/Редактировать/Удалить Goal, Добавление прогресса, Просмотр отчётов, Управление пользователями.

Роли: Администратор, Пользователь

Таблица (кто может что)

| Операция | Администратор | Пользователь | Дополнительные проверки |
|----------|---------------|--------------|-------------------------|
| Просмотр тем (Topics) | ✅ Все | ✅ Все | Нет ограничений |
| Создать Topic | ✅ | ❌ | - |
| Редактировать Topic | ✅ | ❌ | - |
| Удалить Topic | ✅ | ❌ | - |
| Просмотр целей (Goals) | ✅ Все | ✅ Только свои | `WHERE user_id = req.user.id` для user |
| Создать Goal | ✅ | ❌ | Admin назначает цели пользователям |
| Редактировать Goal | ✅ Все поля | ✅ Только name, description, deadline | Проверка: `goal.userId === req.user.id` |
| Удалить Goal | ✅ | ❌ | - |
| Добавить ProgressEntry | ✅ К любой | ✅ Только к своим | Проверка: `goal.userId === req.user.id` |
| Просмотр ProgressEntry | ✅ Все | ✅ Только свои | `WHERE goal.userId = req.user.id` для user |
| Редактировать ProgressEntry | ✅ Любую | ✅ Только свои | Проверка: `entry.goal.userId === req.user.id` |
| Удалить ProgressEntry | ✅ Любую | ✅ Только свои | Проверка: `entry.goal.userId === req.user.id` |
| Генерация отчётов пользователя | ✅ Любого | ✅ Только своих | `/reports/user/{id}`: проверка `id === req.user.id` для user |
| Генерация отчётов по теме | ✅ | ❌ | Только admin |
| Просмотр списка пользователей | ✅ | ❌ | - |
| Создать пользователя | ✅ | ❌ | Через `POST /users` (не `/auth/register`) |
| Редактировать пользователя | ✅ Любого | ✅ Только себя (email, password) | User не может менять username или role |
| Удалить пользователя | ✅ | ❌ | - |

## Примечания по безопасности

### Scope-ограничения (реализация на backend)

1. **Фильтрация на уровне SQL:**

   ```sql
   -- Для обычного пользователя
   SELECT * FROM goals WHERE user_id = $1;
   
   -- Для администратора
   SELECT * FROM goals; -- Без ограничений
   ```

2. **Middleware проверки прав:**

   ```typescript
   // Проверка владельца записи
   if (req.user.role !== 'admin' && resource.userId !== req.user.id) {
     throw new ForbiddenError('Доступ запрещён');
   }
   ```

3. **Валидация на уровне роутов:**
   - Для `GET /goals`: автоматически добавляется фильтр `userId` для роли `user`
   - Для `POST /progress`: проверяется, что `goal.userId === req.user.id`
   - Для `PUT /goals/{id}`: user может менять только определённые поля

### Правила безопасности

- ❌ Пользователь **НЕ может** видеть цели других пользователей
- ❌ Пользователь **НЕ может** добавлять прогресс к чужим целям
- ❌ Пользователь **НЕ может** изменять свою роль или username
- ✅ Администратор **может** просматривать и управлять всеми записями
- ✅ Пользователь **может** редактировать описание и deadline своих целей
