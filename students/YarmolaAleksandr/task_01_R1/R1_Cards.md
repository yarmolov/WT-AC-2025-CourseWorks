# Вариант 09 — Пользовательские истории (User Stories) и критерии приёмки

## Пользовательские истории (минимум 6-10 для R1)

### US-1: Регистрация и вход

**Как** гость  
**Я хочу** зарегистрироваться в системе  
**Чтобы** получить возможность создавать посты и комментировать

**Критерии приёмки (AC):**

- AC1: Форма регистрации содержит поля: email, password, name
- AC2: Email валидируется на корректность формата
- AC3: При успешной регистрации создаётся пользователь с ролью `user`
- AC4: Пароль хешируется перед сохранением в БД (bcrypt)
- AC5: При успешной регистрации возвращается JWT токен
- AC6: Форма входа принимает email и password
- AC7: При успешном входе возвращается JWT токен с userId и role
- AC8: При неверных credentials возвращается ошибка 401

**Валидация:**

- email: обязательное, формат email → ошибка: «Введите корректный email»
- password: обязательное, минимум 6 символов → ошибка: «Пароль должен содержать минимум 6 символов»
- name: обязательное, минимум 2 символа → ошибка: «Введите имя (минимум 2 символа)»

---

### US-2: Создание и публикация поста

**Как** авторизованный пользователь  
**Я хочу** создать новый пост с Markdown-форматированием  
**Чтобы** поделиться своими мыслями с читателями

**Критерии приёмки (AC):**

- AC1: Редактор содержит поля: заголовок, содержание (textarea для Markdown)
- AC2: Кнопка "Сохранить как черновик" сохраняет пост с published = false
- AC3: Кнопка "Опубликовать" сохраняет пост с published = true
- AC4: Можно выбрать теги из существующих (multiselect)
- AC5: Кнопка "Предпросмотр" показывает рендеринг Markdown
- AC6: Пост привязывается к текущему авторизованному пользователю (authorId)
- AC7: После публикации пост появляется в общей ленте
- AC8: Черновики видны только автору в разделе "/drafts"

**Валидация:**

- title: обязательное, минимум 5 символов → ошибка: «Заголовок должен содержать минимум 5 символов»
- content: обязательное, минимум 50 символов → ошибка: «Содержание должно быть минимум 50 символов»
- authorId: автоматически из JWT токена

---

### US-3: Редактирование своего поста

**Как** автор поста  
**Я хочу** редактировать свой опубликованный пост или черновик  
**Чтобы** исправить ошибки или дополнить информацию

**Критерии приёмки (AC):**

- AC1: На странице поста есть кнопка "Редактировать" (только для автора)
- AC2: Клик по кнопке открывает редактор с предзаполненными данными
- AC3: Можно изменить заголовок, содержание, теги
- AC4: Можно изменить статус публикации (черновик ↔ опубликован)
- AC5: После сохранения обновляется поле updatedAt
- AC6: Другие пользователи (не автор) не видят кнопку "Редактировать"
- AC7: Администратор может редактировать любые посты
- AC8: При попытке редактирования чужого поста (не admin) возвращается ошибка 403

**Валидация:**

- Проверка authorId === req.user.id ИЛИ req.user.role === 'admin'
- Те же валидации полей, что при создании

---

### US-4: Удаление своего поста

**Как** автор поста  
**Я хочу** удалить свой пост  
**Чтобы** убрать устаревший или некорректный контент

**Критерии приёмки (AC):**

- AC1: На странице поста есть кнопка "Удалить" (только для автора/admin)
- AC2: Клик вызывает модальное окно подтверждения
- AC3: При подтверждении пост удаляется из БД (каскадно удаляются комментарии и лайки)
- AC4: После удаления происходит редирект на главную страницу
- AC5: При попытке удаления чужого поста (не admin) возвращается ошибка 403

---

### US-5: Просмотр ленты постов

**Как** гость или пользователь  
**Я хочу** видеть список опубликованных постов  
**Чтобы** найти интересный контент для чтения

**Критерии приёмки (AC):**

- AC1: GET /posts возвращает только посты с published = true
- AC2: Для каждого поста показывается: заголовок, превью (первые 200 символов), автор, теги, количество лайков, количество комментариев
- AC3: Посты отсортированы по дате создания (новые первыми)
- AC4: Реализована пагинация (limit, offset или cursor-based)
- AC5: Можно фильтровать по тегам (?tag=технологии)
- AC6: Клик по посту открывает полный текст

---

### US-6: Лайк поста

**Как** авторизованный пользователь  
**Я хочу** лайкнуть понравившийся пост  
**Чтобы** выразить поддержку автору

**Критерии приёмки (AC):**

- AC1: На странице поста есть кнопка "Лайк" (сердечко или иконка)
- AC2: При клике отправляется POST /likes с postId
- AC3: Если лайк уже есть (userId + postId) → лайк удаляется (toggle)
- AC4: Счётчик лайков обновляется в реальном времени
- AC5: Гости видят кнопку, но при клике получают предложение войти
- AC6: В БД соблюдается уникальность (userId, postId)

**Валидация:**

- postId: обязательное, должен существовать → ошибка: «Пост не найден»
- userId: автоматически из JWT токена
- unique(userId, postId) → ошибка: «Вы уже лайкнули этот пост» (или удаление лайка)

---

### US-7: Комментирование поста

**Как** авторизованный пользователь  
**Я хочу** написать комментарий под постом  
**Чтобы** поделиться своим мнением или задать вопрос

**Критерии приёмки (AC):**

- AC1: Под постом есть форма добавления комментария (textarea)
- AC2: При отправке создаётся запись Comment с content, postId, authorId
- AC3: Комментарий сразу появляется в списке комментариев
- AC4: Показывается имя автора комментария и дата создания
- AC5: Автор комментария может его удалить
- AC6: Администратор может удалить любой комментарий

**Валидация:**

- content: обязательное, минимум 3 символа → ошибка: «Комментарий слишком короткий (минимум 3 символа)»
- postId: обязательное, должен существовать
- authorId: автоматически из JWT токена

---

### US-8: Управление тегами (администратор)

**Как** администратор  
**Я хочу** создавать и удалять теги  
**Чтобы** поддерживать порядок в категоризации постов

**Критерии приёмки (AC):**

- AC1: Есть страница /admin/tags со списком всех тегов
- AC2: Можно создать новый тег (поле name)
- AC3: Можно удалить тег (каскадно удаляются связи в PostTag)
- AC4: При удалении тега посты сохраняются, но теряют эту связь
- AC5: Только администратор имеет доступ к этой странице
- AC6: При попытке доступа не-админа возвращается 403

**Валидация:**

- name: обязательное, уникальное, минимум 2 символа → ошибка: «Название тега должно быть уникальным и содержать минимум 2 символа»

---

### US-9: Просмотр черновиков

**Как** авторизованный пользователь  
**Я хочу** видеть список моих черновиков  
**Чтобы** продолжить работу над неопубликованными постами

**Критерии приёмки (AC):**

- AC1: Есть страница /drafts (защищённая)
- AC2: GET /posts?published=false&authorId=currentUser возвращает только черновики автора
- AC3: Для каждого черновика показывается: заголовок, дата создания, дата изменения
- AC4: Клик по черновику открывает редактор
- AC5: Можно опубликовать черновик (кнопка "Опубликовать")
- AC6: Можно удалить черновик

---

### US-10: Управление пользователями (администратор)

**Как** администратор  
**Я хочу** управлять пользователями и их ролями  
**Чтобы** обеспечить безопасность и назначать модераторов

**Критерии приёмки (AC):**

- AC1: Есть страница /admin/users со списком всех пользователей
- AC2: Для каждого пользователя показывается: id, email, name, role
- AC3: Можно изменить роль пользователя (user ↔ admin)
- AC4: Можно удалить пользователя (каскадно удаляются его посты, комментарии, лайки)
- AC5: Только администратор имеет доступ к этой странице
- AC6: При попытке доступа не-админа возвращается 403

---

## Валидация полей сущностей

### User

- **id**: int, PK, autoincrement
- **email**: string, уникальное, обязательное, формат email
  - Ошибка: «Email обязателен и должен быть уникальным»
- **password**: string, обязательное, минимум 6 символов (хешируется)
  - Ошибка: «Пароль должен содержать минимум 6 символов»
- **name**: string, обязательное, минимум 2 символа
  - Ошибка: «Введите имя (минимум 2 символа)»
- **role**: enum [admin, user], обязательное, default: user

### Post

- **id**: int, PK, autoincrement
- **title**: string, обязательное, минимум 5 символов
  - Ошибка: «Заголовок должен содержать минимум 5 символов»
- **content**: string, обязательное, минимум 50 символов
  - Ошибка: «Содержание должно быть минимум 50 символов»
- **published**: boolean, default: false
- **authorId**: int, FK → User.id, обязательное
- **createdAt**: datetime, auto
- **updatedAt**: datetime, auto

### Tag

- **id**: int, PK, autoincrement
- **name**: string, уникальное, обязательное, минимум 2 символа
  - Ошибка: «Название тега должно быть уникальным и содержать минимум 2 символа»

### Comment

- **id**: int, PK, autoincrement
- **content**: string, обязательное, минимум 3 символа
  - Ошибка: «Комментарий слишком короткий (минимум 3 символа)»
- **postId**: int, FK → Post.id, обязательное
- **authorId**: int, FK → User.id, обязательное
- **createdAt**: datetime, auto

### Like

- **id**: int, PK, autoincrement
- **postId**: int, FK → Post.id, обязательное
- **userId**: int, FK → User.id, обязательное
- **@@unique([userId, postId])**: предотвращает дублирование лайков
  - Ошибка: «Вы уже лайкнули этот пост»

### PostTag

- **postId**: int, FK → Post.id
- **tagId**: int, FK → Tag.id
- **@@id([postId, tagId])**: составной первичный ключ
